# Discovery Environment Installation

## Prerequisites

* PostgreSQL 8.4.x
* Tomcat 6.0.x

These instructions were developed using Mac OS X.  Linux distributions should be fairly similar, but there may be differences related to the server setup, user authentication/authorization, etc.

## First-time Setup

### Create the DE database user

	createuser -Upostgres de

	Shall the new role be a superuser? (y/n) n
	Shall the new role be allowed to create databases? (y/n) n
	Shall the new role be allowed to create more new roles? (y/n) n

### Create the DE database

	createdb -Upostgres de

	psql -U postgres -d de -c "alter database de owner to de"
	psql -U postgres -d de -c "alter schema public owner to de"

### Set up .pgpass file to connect to database

This step should not be necessary on Mac OS X, but might be on Linux.

	touch ~/.pgpass
	chmod 600 ~/.pgpass
	echo preview.iplantcollaborative.org:*:de:postgres:$postgresUserPassword >~/.pgpass
	echo preview.iplantcollaborative.org:*:de:de:$DEUserPassword >>~/.pgpass
	echo localhost:*:de:postgres:$postgresUserPassword >>~/.pgpass
	echo localhost:*:de:de:$DEUserPassword >>~/.pgpass

### Clone the database and de-webapp repositories

	git clone ssh://projects.iplantcollaborative.org/repo/applications/de-webapp.git
	git clone ssh://projects.iplantcollaborative.org/repo/schema/database.git

## Build and Deploy

### Deploy database

	cd $DATABASE_MODULE
	mvn package
	psql -Ude -dde -c "drop schema public cascade"
	psql -Ude -dde -c "create schema public"
	(cd target/local-refresh ; sh db_init.sh)

You should see a lot of "drop cascades to table" and then a bunch of "CREATE TABLE" and "INSERT 0 1" statements on the console.

### Deploy application war file

	cd $DE_WEB_MODULE
	mvn package
	rm -rf $TOMCAT_DIR/webapps/de-*
	cp target/de-web.war $TOMCAT_DIR/webapps

### Start Tomcat

	export CATALINA_OPTS=-Xmx1024m
	$TOMCAT_DIR/bin/startup.sh

