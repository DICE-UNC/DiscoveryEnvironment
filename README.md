# clavin-java

A Java client for obtaining configuration settings that were created using
Clavin.  Configuration settings generated by Clavin can either be stored in
Zookeeper or written out to a file.  This library is capable of loading
configuration settings either from Zookeeper or from a file on the classpath.

## Overview

The primary use of this class is through the Clavin client factory,
`org.iplantc.clavin.ClavinClientFactory`, and the Clavin client interface,
`org.iplantc.clavin.ClavinClient`.  Direct usage of Clavin client
implementations is possible, but not recommended.

The simplest way to use this library is to use `ClavinClientFactory` to
automatically create a Clavin client.  This factory will create a Clavin client
that loads configuration settings from a file if a configuration file is found
for the given service name anywhere on the classpath.  For example, if the
service name is `foo` then the file name that the factory looks for is
`foo.properties`.  If a configuration file for the service is not found on the
classpath but a Zookeeper connection information file is available in a
well-known location (`/etc/iplant-services/zkhosts.properties`, by default),
then the factory will return a Clavin cleint that obtains configuration settings
from Zookeeper.  If neither the properties file for the service nor the
Zookeeper connection information file is available then the factory throws an
Exception indicating that it was not able to determine which type of Clavin
client to instantiate.

Here's an example of the simplest usage.

```java
ClavinClientFactory factory = ClavinClientFactory.getClavinClientFactory();
ClavinClient client = factory.getClavinClient("my-service-name");
Properties props = client.loadProperties("my-service-name");
```

Note that the service name is required both when obtaining the Clavin client
instance and when obtaining the configuration settings for the service.  This
allows the service to use the same Clavin client to load multiple sets of
confiugration settings.  One example of this is iPlant's Discovery Environment,
which maintaints its primary configuration settings in
`discoveryenvironment.properties` and its confluence connection information in
`confluence.properties`.  In this case, we would want to obtain the Clavin
client for `discoveryenvironment` and use that client to retrieve the
configuration settings for both `discoveryenvironment` and `confluence`:

```java
ClavinClientFactory factory = ClavinClientFactory.getClavinClientFactory();
ClavinClient client = factory.getClavinClient("discoveryenvironment");
Properties deProps = client.loadProperties("discoveryenvironment");
Properties cfProps = client.loadProperties("confluence");
```

## Customizing the Clavin Client Factory

The Clavin client factory can be customized to look for the Zookeeper connection
information file in a different place or to configure the Zookeeper client in
order to customize the character encoding that is being used and the way the
client behaves when a Zookeeper operations fails.  The available settings are:

<table border='1'>
    <thead>
        <tr><th>Setting</th><th>Description</th><th>Default</th></tr>
    </thead>
    <tbody>
        <tr>
            <td>zkHostsPath</td>
            <td>The path to the Zookeeper connection information file.</td>
            <td>/etc/iplant-services/zkhosts.properties</td>
        </tr>
        <tr>
            <td>retryCount</td>
            <td>The number of times to retry failed Zookeeper operations.</td>
            <td>4</td>
        </tr>
        <tr>
            <td>sleepBetweenTries</td>
            <td>The number of milliseconds to sleep between attempts.</td>
            <td>100</td>
        </tr>
        <tr>
            <td>encoding</td>
            <td>The chracter encoding to use for data in Zookeeper.</td>
            <td>UTF-8</td>
        </tr>
    </tbody>
</table>

Note that all of these configuration settings are applicable only to the
Zookeeper Clavin client; the Clavin client that obtains configuration settings
from a file isn't customizable at this time.

The Clavin client factory provides two static factory methods for creating a
factory, both of which are called `getClavinClientFactory`.  The no-argument
version of this method uses all of the default parameter values from above.
The other version of this method, which has one argument, only specifies the
path to the Zookeeper connection information file.  The other settings,
`retryCount`, `sleepBetweenTries` and `encoding` are all set to their default
values.

For more complicated custimizations, the Clavin client factory provides a
Builder that can be used to select which customizations to use.  Here's an
example Builder usage:

```java
new ClavinClientFactory.Builder()
        .setZkHostsPath("/path/to/zkhosts.properties")
        .setRetryCount(27)
        .setSleepBetweenTries(5000)
        .setEncoding("ISO-8859-1")
        .build();
```

Using the builder, any of the customizable parameters (or none of them at all)
can be altered.  The static factory methods in ClavinClientFactory are provided
only for convenience.

## Using the Clavin Client Implementations Separately

Both Clavin client implementations can be used by themselves if necessary.  To
obtain a client that loads configuration settings from files, you can use
`org.iplantc.clavin.files.FilesClavinClient`:

```java
ClavinClient client = new FilesClavinClient();
Properties props = client.loadProperties("my-service-name");
```

To obtain a client that loads configuration settings from Zookeeper, you can use
`org.iplantc.clavin.zookeeper.ZookeeperClavinClient`.  Using the Zookeeper
Clavin client is a little more involved, because this library has an extra level
of indirection to help shield it from changes to the third-party library that it
uses to communicate with Zookeeper.  Here's an example:

```
String connectionSpec = "localhost:2181";
int retryCount = 4;
int sleepBetweenTries = 100;
String encoding = "UTF-8";
ZkClient zkClient = new ZkClientImpl(connectionSpec, retryCount,
        sleepBetweenTries, encoding);
ZookeeperClavinClient client = new ZookeeperClavinClient(zkClient);
Properties props = client.loadProperties("my-service-name");
```

ZkClientImpl also has a constructor that takes only the connection
specification, and another constructor that takes only the connection
specification, the number of retry attempts, and the number of milliseconds to
sleep between attempts.

More information about both of these client implementations is available in the
API documentation.

## Diagnostics

This library throws subclasses of `ClavinException` for most error conditions.
Below is a description of each custom exception that is thrown.

### ClavinException

This is the base class of most of the exceptions thrown by this library; it is a
runtime exception, so there's no need to catch it unless you want to attempt to
handle the exception automatically.

### ClavinClientCreationException

A Clavin client factory was used to obtain a Clavin client instance and neither
the configuration file for the service nor the Zookeeper connection information
file was found.  Ensure that the necessary files are available, the service name
is correct, and selected path to the Zookeeper connection information file is
correct.

### InvalidZkHostsException

The Zookeeper connection information file was found but the configuration
setting for the connection string, `zookeeper`, was not found.  Check the
Zookeeper connection information file to ensure that the connection string
property name is correct.

### PropertyLoadException

A configuration file for the service was found in the classpath but could not be
loaded.  Verify that the operating system account used to run the service has
permission to read the configuration file and that the configuration file is a
valid properties file.

### ServiceNotPermittedException

The service is not permitted to run on the local host.  If configuration
settings are being read from a file, this means that no configuraiton file was
found on the classpath for the service.  If configuration settings are being
read from Zookeeper, this means that the current host is not listed as a service
host in the ACLs that were loaded into Zookeeper by Clavin.  If you expect the
configuration settings to come from a file, ensure that the file is available on
the classpath.  If you expect the configuration settings to come from Zookeeper,
verify that the ACLs are correct.

### ZkHostsReadException

The Zookeeper connection information file was found, but could not be read.
Ensure that the operating system account used to run the service has permission
to read the file.

### FileCloseException

A file was opened but could not be closed.  Check the operating system logs for
errors.

### IpAddressNotFoundException

An attempt to look up the IP address for the local host failed.  Ensure that the
network interface is up and that the computer is connected to a network.

### ChildListException

An attempt to read the list of children of a node in Zookeeper failed.  Verify
that Zookeeper is up and that the configuration settings in Zookeeper are
correct.

### ReadNodeException

An attempt to retrieve data from a node in Zookeeper failed.  Verify that
Zookeeper is up and that the configuration settings in Zookeeper are correct.

### ZookeeperConnectionException

The Clavin client library was unable to connect to Zookeeper.  Verify that
Zookeeper is up, the connection string is correct and that the connections to
the Zookeeper hosts and ports are not being blocked by a firewall.

## Known Issues

There are no known bugs in this library.  Please report problems to the Core
software development team at iPlant.  Patches are welcome.

## License

Copyright (c) 2012, The Arizona Board of Regents on behalf of 
The University of Arizona

All rights reserved.

Developed by: iPlant Collaborative as a collaboration between
participants at BIO5 at The University of Arizona (the primary hosting
institution), Cold Spring Harbor Laboratory, The University of Texas at
Austin, and individual contributors. Find out more at 
http://www.iplantcollaborative.org/.

Redistribution and use in source and binary forms, with or without 
modification, are permitted provided that the following conditions are
met:

 * Redistributions of source code must retain the above copyright 
   notice, this list of conditions and the following disclaimer.
 * Redistributions in binary form must reproduce the above copyright 
   notice, this list of conditions and the following disclaimer in the 
   documentation and/or other materials provided with the distribution.
 * Neither the name of the iPlant Collaborative, BIO5, The University 
   of Arizona, Cold Spring Harbor Laboratory, The University of Texas at 
   Austin, nor the names of other contributors may be used to endorse or 
   promote products derived from this software without specific prior 
   written permission.

THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS
IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED 
TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A 
PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT 
HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED
TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF
LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING
NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS 
SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
